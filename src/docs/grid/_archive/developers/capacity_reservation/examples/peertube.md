# How to deploy a PeerTube instance on 0-OS

In this tutorial we are going to deploy an [PeerTube](https://github.com/Chocobozzz/PeerTube) instance on a virtual 0-OS we have reserved.

PeerTube is a decentralized video hosting network, based on free/libre software.

## Summary

- Convert docker image into flist
- Create the containers on 0-OS
- Create a reverse proxy to expose PeerTube to the public

### Convert docker image into flist

First things to do is to head to their github repository and look what is the recommended way to deploy a peer tube instance.
They have some docker images prepared for an easy deployement. We will leverage those to create the flist needed to deploy container on 0-OS.

The PeerTube documentation points to a doker-compose file: https://raw.githubusercontent.com/chocobozzz/PeerTube/master/support/docker/production/docker-compose.yml
From this file we see that a PeerTube instance is composed of 4 containers:

- postfix: mwader/postfix-relay
- redis: redis:4-alpine
- postgres: postgres:10-alpine
- peertube: chocobozzz/peertube:production-stretch

To convert these docker image in usable flist, go to https://hub.grid.tf/docker-convert.

![tfhub docker convertion](images/hub-convert.png)


Paste the name of the container you want to convert into an flist and click the button `convert the docker image`.

The result of the conversion shoul show something like:

![flist converted](images/flist-created.png)

Repeat this process for the 4 docker image required by peertube.

### Create containers on 0-OS

Now that we have all the flist we need, let's start creating containers

1. Create a client to your 0-OS. Adapt the `host` argument in the next snippet to match the IP you received in the mail of confirmation when you reserved your 0-OS

```python
node = j.clients.zos.get('local', host='10.102.224.45')
node.client.ping()
```

2. Create the postfix container

```python
postfix = node.containers.create('postfix','https://hub.grid.tf/zaibon/mwader-postfix-relay-latest.flist',env={'POSTFIX_myhostname':'tube.zaibon.be'})
```

3. Create the redis container and retrieve its internal IP, we will needed for the PeerTube configuration

```python
redis = node.containers.create('redis','https://hub.grid.tf/zaibon/redis-4-alpine.flist')
redis_ip = str(redis.default_ip().ip)
```

4. Create the postgres container and retrieve its internal IP, we will needed for the PeerTube configuration

Notice how here we set an environment variable to configure the container. `POSTGRES_DB` will tell the container to create a database called `peertube` at startup.

```python
postgres = node.containers.create('postgres','https://hub.grid.tf/zaibon/postgres-10-alpine.flist', env={'POSTGRES_DB':'peertube'})
postgres_ip  = str(postgres.default_ip().ip)
```

5. Create peertube container

Here we create a port forward in the container. The tcp port 9000 in the container will be forwarded to the port 9000 on the host 0-OS.

We also configure the PeerTube instance with different environment variables. Let's go over them:

- `PEERTUBE_DB_HOSTNAME`: set it to the ip of the postgres container
- `PEERTUBE_WEBSERVER_HOSTNAME`: set it to the domain you want people to reach your instance
- `PEERTUBE_ADMIN_EMAIL`: set it to your email address.
- `PEERTUBE_REDIS_HOSTNAME`: set it to the ip of the redis container

```python
peertube = node.containers.create(
    name='peertube',
    flist='https://hub.grid.tf/zaibon/chocobozzz-peertube-production-stretch.flist',
    ports={9000:9000},
    env={
        "PEERTUBE_DB_HOSTNAME": postgres_ip,
        "PEERTUBE_DB_USERNAME": 'postgres',
        "POSTGRES_DB": 'postgres',
        "PEERTUBE_DB_PASSWORD": 'postgres',
        "PEERTUBE_WEBSERVER_HOSTNAME": 'tube.zaibon.be',
        "PEERTUBE_WEBSERVER_PORT": "443",
        "PEERTUBE_WEBSERVER_HTTPS": "true",
        "PEERTUBE_ADMIN_EMAIL": 'zaibon@mailinator.com',
        "PEERTUBE_REDIS_HOSTNAME": redis_ip,
    })

peertube_public_url = "http://%s:9000" % node.host
```

The last line is to create the URL that we will have to pass to the reverse proxy reservation.

Your PeerTube instance should now be running.

You will need to know the root password to be able to manage your peertuve instance. The password is automatically generated by the container the firs time it starts. To retrieve the passwored, we are going to stream the logs of the container and parse the logs to get the password:
```python
def cb(level, line, flag):
    if line.find("User password") == -1:
        return
    password = line.split(" ")[-1]
    print("password is %s"% password)
sub = peertube.client.subscribe('entry')
sub.stream(cb)
# the sub.stream method will print something like:
password is xulufugaliyijehq
```

Remember this password, you will need it to authenticate as root user in your peertube instance

### Create a reverse proxy to expose PeerTube to the public

The last step is to expose your PeerTube instance to the public. In order to do that we will reserve a reverse proxy on the grid and make it expose the PeerTube container.

But before doing the reservation, you need to point the DNS of the domain you set in `PEERTUBE_WEBSERVER_HOSTNAME` variable to `185.69.166.31`. This is the IP of the reverse proxy of the grid.

Once you DNS configuration is done, you can reserve a proxy:

```python
client = j.clients.tfchain.get('testnet1')
wallet = client.wallets.get('main')
result =wallet.capacity.reserve_reverse_proxy('zaibon@mailinator.com', 'zaibon.tf3bot', domain='tube.zaibon.be', backend_urls=[peertube_public_url])
```

Once you received the confirmation email that your reverse proxy is deployed, you can head to the domain you just configured and admire your PeerTube instance